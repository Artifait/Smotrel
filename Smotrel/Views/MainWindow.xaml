<Window x:Class="Smotrel.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vms="clr-namespace:Smotrel.ViewModels"
        Title="Smotrel Player" Height="600" Width="1000"
        Background="#1E1E1E" Foreground="White" Icon="/Views/Sprite-0001.ico"        
        xmlns:conv="clr-namespace:Smotrel.Converters">


    <Window.Resources>
        <conv:DurationToStringConverter x:Key="DurationToStringConverter"/>
        <conv:WatchedToStringConverter x:Key="WatchedToStringConverter"/>
        <conv:ItemsCountToHeightConverter x:Key="ItemsCountToHeightConverter"/>

        <!-- Общие стили -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <Style TargetType="Slider">
            <Setter Property="Foreground" Value="#FFDD00"/>
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid>
                            <Track x:Name="PART_Track">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="Slider.DecreaseLarge"
                                                  Background="#FFDD00"
                                                  Height="4" Margin="0"/>
                                </Track.DecreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Width="12" Height="12" Background="#FFDD00" BorderBrush="Black" BorderThickness="1"/>
                                </Track.Thumb>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="Slider.IncreaseLarge"
                                                  Background="#333"
                                                  Height="4" Margin="0"/>
                                </Track.IncreaseRepeatButton>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Стиль карточки плейлиста -->
        <DataTemplate x:Key="PlaylistItemTemplate" DataType="{x:Type vms:PlaylistItemViewModel}">
            <Border Padding="8" Margin="1" Background="#222" CornerRadius="6">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Vertical">
                        <!-- ShortTitle показываем, Tooltip содержит полный title без платформы -->
                        <TextBlock Text="{Binding ShortTitle}"
                           FontWeight="SemiBold"
                           TextTrimming="CharacterEllipsis"
                           ToolTip="{Binding FullTitle}"
                           FontSize="14" />
                        <StackPanel Orientation="Horizontal" Margin="0,3,0,0">
                            <TextBlock Text="{Binding Duration, Converter={StaticResource DurationToStringConverter}}" FontSize="12" Foreground="#CCCCCC"/>
                            <TextBlock Text=" • " FontSize="12" Foreground="#666" Margin="3,0"/>
                            <TextBlock Text="{Binding Watched, Converter={StaticResource WatchedToStringConverter}}" FontSize="12" Foreground="#999"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- опционально: правый столбец (иконка/чат) -->
                    <TextBlock Grid.Column="1" Text="▶" VerticalAlignment="Center" Opacity="0.2" Margin="8,0,0,0"/>
                </Grid>
            </Border>
        </DataTemplate>

    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="375"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Левая панель -->
        <Grid>
            <Grid.RowDefinitions>
                <!-- Верхний блок: заголовок + оглавление -->
                <RowDefinition Height="Auto"/>

                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <!-- Плейлист -->
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Button Content="📂 Выбрать папку" Command="{Binding BrowseCommand}" />

            <TreeView Margin="6" Grid.Row="1"
                      ItemsSource="{Binding Root.SubFolders}"
                      Background="#2A2A2A" Foreground="White">
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate DataType="{x:Type vms:FolderNodeViewModel}"
                                              ItemsSource="{Binding SubFolders}">
                        <TextBlock Text="{Binding Title}" FontWeight="Bold" Foreground="White">
                            <TextBlock.InputBindings>
                                <MouseBinding Gesture="LeftDoubleClick"
                                              Command="{Binding OpenFolderCommand}"/>
                            </TextBlock.InputBindings>
                        </TextBlock>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
            </TreeView>

            <TextBlock Text="Плейлист" Grid.Row="2" FontWeight="Bold" Margin="4" />

            <ListBox x:Name="PlaylistListBox" Grid.Row="3"
                     ItemsSource="{Binding Playlist, UpdateSourceTrigger=PropertyChanged}"
                     SelectedIndex="{Binding SelectedIndex}"
                     ItemTemplate="{StaticResource PlaylistItemTemplate}"
                     Background="#2A2A2A" Foreground="White"
                     Margin="6"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"/>

        </Grid>

        <!-- Правая панель: плеер с оверлеем -->
        <Grid Grid.Column="1" Margin="8">
            <Grid x:Name="PlayerContainer"
                  MouseEnter="PlayerContainer_MouseEnter"
                  MouseLeave="PlayerContainer_MouseLeave"
                  MouseMove="PlayerContainer_MouseMove"
                  SizeChanged="PlayerContainer_SizeChanged">

                <!-- Видео -->
                <MediaElement x:Name="Player"
                              Source="{Binding CurrentVideoPath}"
                              LoadedBehavior="Manual"
                              UnloadedBehavior="Stop"
                              Stretch="Uniform"
                              MouseLeftButtonDown="Player_MouseLeftButtonDown"
                              MediaOpened="Player_MediaOpened" />

                <!-- Оверлей на весь экран видео (контролы внутри) -->
                <Grid x:Name="ControlOverlay"
                      Background="#40000000"
                      Opacity="1"
                      Visibility="Visible"
                      IsHitTestVisible="True">

                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Верх: название -->
                    <Border Background="#80000000" Padding="10">
                        <TextBlock Text="{Binding CurrentVideoTitle}"
                                   FontSize="18"
                                   TextTrimming="CharacterEllipsis"
                                   VerticalAlignment="Center"/>
                    </Border>

                    <!-- Центр — прозрачная зона для клика -->
                    <Border Grid.Row="1"
                            Background="Transparent"
                            MouseLeftButtonDown="Player_MouseLeftButtonDown"/>

                    <!-- Большой центрированный индикатор -->
                    <TextBlock x:Name="centerIcon"
                               Grid.Row="1"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               FontSize="96"
                               FontWeight="Bold"
                               Opacity="0"
                               Visibility="Collapsed"
                               IsHitTestVisible="False"
                               Text="▶">
                        <TextBlock.RenderTransform>
                            <ScaleTransform ScaleX="1" ScaleY="1" />
                        </TextBlock.RenderTransform>
                    </TextBlock>

                    <!-- Resume banner (right-bottom inside player) -->
                    <StackPanel x:Name="ResumeBanner"
                                Grid.Row="1"
                                Orientation="Vertical"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Bottom"
                                Margin="0"
                                Visibility="Collapsed">
                        <Border Background="#AA111111" Padding="8" CornerRadius="6 0 0 0">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock x:Name="ResumeText"
                                           Text="Продолжить с 0:00?"
                                           VerticalAlignment="Center"
                                           Margin="0,0,8,0"
                                           FontSize="14"/>
                                <Button x:Name="BtnResume"
                                        Click="BtnResume_Click"
                                        Content="▶ Продолжить"
                                        Margin="0,0,6,0"/>
                                <Button x:Name="BtnClearResume"
                                        Click="BtnClearResume_Click"
                                        Content="✖ Сбросить"/>
                            </StackPanel>
                        </Border>

                        <Border Height="6" CornerRadius="3" Margin="0,6,0,0" Background="#333" Padding="1">
                            <ProgressBar x:Name="ResumeProgressBar"
                                         Height="4"
                                         Minimum="0"
                                         Maximum="1000"
                                         Value="0"
                                         IsIndeterminate="False"
                                         Foreground="#FFDD00"
                                         Background="#555"
                                         BorderThickness="0"/>
                        </Border>
                    </StackPanel>

                    <!-- PiP overlay — ПОЛНОЭКРАННОЕ, должен быть последним дочерним элементом внутри ControlOverlay
                         чтобы покрывать и видео и нижние контролы (order matters) -->
                    <Border x:Name="PiPModeOverlay"
                            Grid.RowSpan="3"
                            Background="#BF000000"
                            Visibility="Collapsed"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            CornerRadius="0"
                            Panel.ZIndex="1000"
                            IsHitTestVisible="True">
                        <Grid>
                            <TextBlock Text="Воспроизводится в PiP" Foreground="#FFDD00"
                                       FontSize="16" FontWeight="Bold"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Grid>
                    </Border>

                    <!-- Низ: панель управления -->
                    <StackPanel Grid.Row="2"
                                Orientation="Vertical"
                                Background="#80000000"
                                Margin="0"
                                IsHitTestVisible="True">

                        <Grid Margin="6">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition />
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Slider x:Name="videoSlider"
                                    Grid.Column="0"
                                    Minimum="0"
                                    Maximum="100"
                                    PreviewMouseDown="Slider_PreviewMouseDown"
                                    PreviewMouseUp="Slider_PreviewMouseUp"/>

                            <TextBlock x:Name="timeText"
                                       Grid.Column="1"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"
                                       FontSize="14"
                                       Text="0:00 / 0:00"/>
                        </Grid>

                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Center"
                                    Margin="0,0,0,4">
                            <Button Command="{Binding PrevCommand}" Content="⏮"/>
                            <Button x:Name="btnPausePlay" Command="{Binding PausePlayCommand}" Content="⏸"/>
                            <Button Command="{Binding NextCommand}" Content="⏭"/>

                            <StackPanel Orientation="Horizontal" Margin="20,0" VerticalAlignment="Center">
                                <TextBlock Text="🔊" FontSize="18" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <Slider x:Name="volumeSlider"
                                        Minimum="0"
                                        Maximum="1"
                                        Value="0.5"
                                        Width="100"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="10,0" VerticalAlignment="Center">
                                <ComboBox Width="80"
                                          ItemsSource="{Binding AvailablePlaybackRates}"
                                          SelectedItem="{Binding SelectedPlaybackRate, Mode=TwoWay}"
                                          HorizontalAlignment="Left"
                                          VerticalAlignment="Center">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding StringFormat={}{0:0.##}x}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <Button x:Name="btnPiP" Content="◧ PiP" Click="BtnPiP_Click"/>

                            <Button Command="{Binding FullscreenCommand}" Content="⛶"/>
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</Window>
