<UserControl x:Class="Smotrel.Controls.CourseNavigation"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="clr-namespace:Smotrel.Models"
             x:Name="Root"
             MinWidth="260">
    <Border Background="{StaticResource WindowBackgroundBrush}" Padding="8">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header: Parent button and current chapter title (editable) -->
            <DockPanel Grid.Row="0" LastChildFill="True" Margin="0,0,0,8" VerticalAlignment="Center">
                <Button x:Name="ParentBtn" Content="◄" Width="36" Height="28" Click="ParentBtn_Click" Visibility="Collapsed" ToolTip="Up"/>
                <TextBlock x:Name="HeaderTitle" Text="{Binding CurrentChapter.Title, ElementName=Root}" FontSize="16"
                           VerticalAlignment="Center" Margin="8,0,0,0" TextTrimming="CharacterEllipsis"
                           MouseLeftButtonDown="HeaderTitle_MouseLeftButtonDown"/>
                <!-- Hidden TextBox for renaming header -->
                <TextBox x:Name="HeaderEditBox" Visibility="Collapsed" VerticalAlignment="Center"
                         KeyDown="HeaderEditBox_KeyDown" LostFocus="HeaderEditBox_LostFocus" MinWidth="120"/>
            </DockPanel>

            <!-- Body: chapters and videos in explorer style -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                <StackPanel Orientation="Vertical" >

                    <!-- Child chapters -->
                    <ItemsControl ItemsSource="{Binding CurrentChapter.Chapters, ElementName=Root}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:ChapterCourseModel}">
                                <Border Padding="6" Margin="0,0,0,6" Background="{StaticResource TextBoxBackgroundBrush}" CornerRadius="4">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Icon -->
                                        <TextBlock Grid.Column="0" Text="📁" VerticalAlignment="Center" Margin="0,0,8,0"/>

                                        <!-- Title (TextBlock + TextBox for inline edit) -->
                                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                                            <TextBlock x:Name="ChapterTitleBlock" Text="{Binding Title}" VerticalAlignment="Center"
                                                       MouseLeftButtonDown="ChapterTitleBlock_MouseLeftButtonDown"
                                                       MouseDown="ChapterTitleBlock_MouseDown"
                                                       TextTrimming="CharacterEllipsis"/>
                                            <TextBox x:Name="ChapterTitleEdit" Visibility="Collapsed" Width="220"
                                                     LostFocus="ChapterTitleEdit_LostFocus" KeyDown="ChapterTitleEdit_KeyDown"/>
                                        </StackPanel>

                                        <!-- Open button -->
                                        <Button Grid.Column="2" Content="Open" Width="56" Height="28" Click="OpenChapterBtn_Click" Tag="{Binding}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Divider -->
                    <Separator Margin="0,6,0,6"/>

                    <!-- Videos -->
                    <ItemsControl ItemsSource="{Binding CurrentChapter.Videos, ElementName=Root}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:VideoModel}">
                                <Border Padding="6" Margin="0,0,0,8" Background="{StaticResource TextBoxBackgroundBrush}" CornerRadius="4">
                                    <StackPanel Orientation="Vertical">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Play icon -->
                                            <TextBlock Grid.Column="0" Text="▶" VerticalAlignment="Center" Margin="0,0,8,0" FontSize="16"/>

                                            <!-- Title & inline edit -->
                                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                <TextBlock x:Name="VideoTitleBlock" Text="{Binding Title}" VerticalAlignment="Center"
                                                           MouseLeftButtonDown="VideoTitleBlock_MouseLeftButtonDown"
                                                           MouseDown="VideoTitleBlock_MouseDown"
                                                           TextTrimming="CharacterEllipsis"/>
                                                <TextBox x:Name="VideoTitleEdit" Visibility="Collapsed" Width="220"
                                                         LostFocus="VideoTitleEdit_LostFocus" KeyDown="VideoTitleEdit_KeyDown"/>
                                                <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" Foreground="{StaticResource MediumGrayBrush}"
                                                           Text="{Binding Duration, StringFormat='{}{0:hh\\:mm\\:ss}'}"/>
                                            </StackPanel>

                                            <!-- Expand/Collapse icon -->
                                            <Button Grid.Column="2" Content="⤵" Width="36" Height="28" Click="VideoExpandBtn_Click" Tag="{Binding}"/>
                                        </Grid>

                                        <!-- Expanded area: timestamps and add button -->
                                        <StackPanel x:Name="TimestampsPanel" Margin="18,6,0,0" Visibility="Collapsed">
                                            <ItemsControl ItemsSource="{Binding Timestamps}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Time, StringFormat='[{0:hh\\:mm\\:ss}]'}" ToolTip="{Binding Description}"
                                                                   MouseLeftButtonDown="Timestamp_MouseLeftButtonDown" Tag="{Binding}"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <Button Content="Add timestamp" Width="120" Height="28" Margin="0,6,0,0"
                                                    Click="AddTimestampBtn_Click" Tag="{Binding}"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Border>
</UserControl>